name: 'Validate Workspace'
description: 'Comprehensive workspace validation for monorepo - install, lint, test, and build all packages'
inputs:
  node-version:
    description: 'Node.js version to use'
    required: false
    default: '20'
  skip-install:
    description: 'Skip dependency installation'
    required: false
    default: 'false'
  skip-lint:
    description: 'Skip linting'
    required: false
    default: 'false'
  skip-test:
    description: 'Skip testing'
    required: false
    default: 'false'
  skip-build:
    description: 'Skip build'
    required: false
    default: 'false'
outputs:
  pr-comment-body:
    description: 'Complete PR comment body text'
    value: ${{ steps.summary.outputs.comment-body }}
  validation-result:
    description: 'Overall validation result'
    value: ${{ steps.summary.outputs.result }}
runs:
  using: composite
  steps:
    - name: ğŸ“‹ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ inputs.node-version }}
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      id: install
      if: inputs.skip-install != 'true'
      shell: bash
      run: |
        echo "ğŸ“¦ Installing all workspace dependencies..."
        npm install
        echo "âœ… Dependencies installed successfully"

    - name: ğŸ” Run linting
      id: lint
      if: inputs.skip-lint != 'true'
      shell: bash
      run: |
        echo "ğŸ” Running ESLint across all workspaces..."
        npm run lint
        echo "âœ… Linting completed successfully"

    - name: ğŸ—ï¸ Build packages
      id: build
      if: inputs.skip-build != 'true'
      shell: bash
      run: |
        echo "ğŸ—ï¸ Building all packages..."
        npm run build
        echo "âœ… Build completed successfully"

    - name: ğŸ§ª Run tests
      id: test
      if: inputs.skip-test != 'true'
      shell: bash
      run: |
        echo "ğŸ§ª Running tests across all workspaces..."
        npm run test
        echo "âœ… Tests completed successfully"

    - name: ğŸ“Š Generate PR Comment
      id: summary
      shell: bash
      run: |
        # Collect outcomes
        install="${{ steps.install.outcome || 'skipped' }}"
        lint="${{ steps.lint.outcome || 'skipped' }}"
        test="${{ steps.test.outcome || 'skipped' }}"
        build="${{ steps.build.outcome || 'skipped' }}"

        # Generate step results
        install_icon=$([ "$install" = "success" ] && echo "âœ…" || echo "âŒ")
        lint_icon=$([ "$lint" = "success" ] && echo "âœ…" || echo "âŒ")
        test_icon=$([ "$test" = "success" ] && echo "âœ…" || echo "âŒ")
        build_icon=$([ "$build" = "success" ] && echo "âœ…" || echo "âŒ")

        install_bool=$([ "$install" = "success" ] && echo "true" || echo "false")
        lint_bool=$([ "$lint" = "success" ] && echo "true" || echo "false")
        test_bool=$([ "$test" = "success" ] && echo "true" || echo "false")
        build_bool=$([ "$build" = "success" ] && echo "true" || echo "false")

        # Determine overall result
        if [[ "$install $lint $test $build" == *"failure"* ]]; then
          title="âŒ **PR Validation Failed**"
          summary_text="ğŸ”§ Please fix the failing steps and try again."
          result="failure"
        else
          title="âœ… **Pull Request Validation Successful**"
          summary_text="ğŸ‰ All quality checks passed! Ready to merge."
          result="success"
        fi

        # Generate complete comment body
        cat << 'COMMENT_EOF' > comment.txt
        $title

        **Step Results:**
        - $install_icon **ğŸ“¦ Install dependencies:** $install_bool
        - $lint_icon **ğŸ” Run linting:** $lint_bool
        - $test_icon **ğŸ§ª Run tests:** $test_bool
        - $build_icon **ğŸ—ï¸ Build packages:** $build_bool

        $summary_text

        ğŸ“‹ [View workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
        COMMENT_EOF

        # Substitute variables in the comment
        sed -i "s/\$title/$title/g" comment.txt
        sed -i "s/\$install_icon/$install_icon/g" comment.txt
        sed -i "s/\$lint_icon/$lint_icon/g" comment.txt
        sed -i "s/\$test_icon/$test_icon/g" comment.txt
        sed -i "s/\$build_icon/$build_icon/g" comment.txt
        sed -i "s/\$install_bool/$install_bool/g" comment.txt
        sed -i "s/\$lint_bool/$lint_bool/g" comment.txt
        sed -i "s/\$test_bool/$test_bool/g" comment.txt
        sed -i "s/\$build_bool/$build_bool/g" comment.txt
        sed -i "s/\$summary_text/$summary_text/g" comment.txt

        # Set outputs
        {
          echo "comment-body<<EOF"
          cat comment.txt
          echo "EOF"
        } >> $GITHUB_OUTPUT
        echo "result=$result" >> $GITHUB_OUTPUT
