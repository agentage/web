name: 'Validate Workspace'
description: 'Comprehensive workspace validation - install, lint, type-check, and build all packages'
inputs:
  node-version:
    description: 'Node.js version to use'
    required: false
    default: '20'
  skip-install:
    description: 'Skip dependency installation'
    required: false
    default: 'false'
  skip-lint:
    description: 'Skip linting'
    required: false
    default: 'false'
  skip-build:
    description: 'Skip build'
    required: false
    default: 'false'
outputs:
  pr-comment-body:
    description: 'Complete PR comment body text'
    value: ${{ steps.summary.outputs.comment-body }}
  validation-result:
    description: 'Overall validation result'
    value: ${{ steps.summary.outputs.result }}
runs:
  using: composite
  steps:
    - name: ğŸ“‹ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ inputs.node-version }}
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      id: install
      if: inputs.skip-install != 'true'
      shell: bash
      run: |
        echo "ğŸ“¦ Installing all workspace dependencies..."
        npm ci
        echo "âœ… Dependencies installed successfully"

    - name: ğŸ” Run linting
      id: lint
      if: inputs.skip-lint != 'true'
      shell: bash
      run: |
        echo "ğŸ” Running ESLint..."
        npm run lint
        echo "âœ… Linting completed successfully"

    - name: ğŸ” Type checking
      id: typecheck
      if: inputs.skip-build != 'true'
      shell: bash
      run: |
        echo "ğŸ” Running TypeScript type checking..."
        npm run type-check
        echo "âœ… Type checking completed successfully"

    - name: ğŸ—ï¸ Build packages
      id: build
      if: inputs.skip-build != 'true'
      shell: bash
      run: |
        echo "ğŸ—ï¸ Building all packages..."
        npm run build
        echo "âœ… Build completed successfully"

    - name: ğŸ“Š Generate PR Comment
      id: summary
      shell: bash
      run: |
        install="${{ steps.install.outcome || 'skipped' }}"
        lint="${{ steps.lint.outcome || 'skipped' }}"
        typecheck="${{ steps.typecheck.outcome || 'skipped' }}"
        build="${{ steps.build.outcome || 'skipped' }}"

        install_icon=$([ "$install" = "success" ] && echo "âœ…" || [ "$install" = "skipped" ] && echo "â­ï¸" || echo "âŒ")
        lint_icon=$([ "$lint" = "success" ] && echo "âœ…" || [ "$lint" = "skipped" ] && echo "â­ï¸" || echo "âŒ")
        typecheck_icon=$([ "$typecheck" = "success" ] && echo "âœ…" || [ "$typecheck" = "skipped" ] && echo "â­ï¸" || echo "âŒ")
        build_icon=$([ "$build" = "success" ] && echo "âœ…" || [ "$build" = "skipped" ] && echo "â­ï¸" || echo "âŒ")

        if [[ "$install $lint $typecheck $build" == *"failure"* ]]; then
          title="âŒ **PR Validation Failed**"
          summary_text="ğŸ”§ Please fix the failing steps and try again."
          result="failure"
        else
          title="âœ… **Pull Request Validation Successful**"
          summary_text="ğŸ‰ All quality checks passed! Ready to merge."
          result="success"
        fi

        cat << EOF > comment.txt
        $title

        **Step Results:**
        - $install_icon **Install dependencies:** $install
        - $lint_icon **Linting:** $lint
        - $typecheck_icon **Type checking:** $typecheck
        - $build_icon **Build packages:** $build

        $summary_text
        EOF

        {
          echo "comment-body<<COMMENT_EOF"
          cat comment.txt
          echo "COMMENT_EOF"
        } >> $GITHUB_OUTPUT
        echo "result=$result" >> $GITHUB_OUTPUT
